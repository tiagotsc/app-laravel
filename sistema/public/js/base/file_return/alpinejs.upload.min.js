document.addEventListener("alpine:init",(()=>{Alpine.data("managerFrm",(()=>({modalStatus:new bootstrap.Modal(document.getElementById("modal-status")),modalConfirmLow:new bootstrap.Modal(document.getElementById("modal-confirm-low")),data:{_token:document.head.querySelector("meta[name=csrf-token]").content,_method:"post"},loading:!1,buttonLabel:"Enviar",loadData(){document.querySelector("#file").addEventListener("change",(e=>{$("#frm").valid()}))},setModalStatus(e,t){document.getElementById("title-modal-status").innerText=e,document.getElementById("desc-status-modal").innerText=t},setMsgModalConfirm(e="",t="",o=""){document.getElementById("confirmLowModalLabel").innerText=e,document.getElementById("modal-confirm-low-desc").innerText=t,document.getElementById("return-confirm-low").innerHTML=o},hideBtsConfirm(){document.getElementById("bt-close-confirm-low").hidden=!0,document.getElementById("confirm-low").hidden=!0},showBtsConfirm(){document.getElementById("bt-close-confirm-low").hidden=!1,document.getElementById("confirm-low").hidden=!1},btCloseConfirm(){document.getElementById("progress-bar").style.width="0%",document.getElementById("progress-bar").innerHTML="0%"},submitData(){if($("#frm").valid()){this.showBtsConfirm();let e=this,t=new FormData,o=$("#file")[0].files;t.append("file",o[0]),t.append("moment_session",document.getElementById("moment_session").value),t.append("_token",document.head.querySelector("meta[name=csrf-token]").content),this.buttonLabel="Aguarde, enviando arquivo...",this.loading=!0;let n=new XMLHttpRequest;n.responseType="json",n.onload=function(){if(200===n.status){let t=n.response;e.setMsgModalConfirm("Deseja baixar?",`${t.count_registers} registros em ${t.count_batchs} lotes`)}else e.setMsgModalConfirm("Algo errado!","Se persistir, fale com o administrador!");e.modalConfirmLow.show(),e.loading=!1,e.buttonLabel="Enviar",document.getElementById("file").value=""},n.upload.onprogress=function(e){let t=Math.round(e.loaded/e.total*100);document.getElementById("progress-bar").style.width=t+"%",document.getElementById("progress-bar").innerHTML=t+"%"},n.open("POST",document.getElementById("frm").action),n.send(t)}},uploadStore(){let e=document.getElementById("moment_session").value,t=document.getElementById("route_upload_update").value.replace("*",e);this.hideBtsConfirm(),this.setMsgModalConfirm("","","Aguarde, preparando a baixa..."),fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({_token:document.head.querySelector("meta[name=csrf-token]").content,_method:"put"})}).then((e=>e.json())).then((e=>{1!=e.status?this.setMsgModalConfirm("Algo errado!","Não foi possível realizar a baixa dos lotes.",""):(this.setMsgModalConfirm("Baixa em andamento!","Assim que terminar avisaremos por e-mail.",""),document.getElementById("progress-bar").style.width="0%",document.getElementById("progress-bar").innerHTML="0%")})).catch((()=>{this.setMsgModalConfirm("Error grave! Ao baixar lotes!","Se persistir, fale com o administrador!","")})).finally((()=>{document.getElementById("bt-close-confirm-low").hidden=!1}))}})))}));
