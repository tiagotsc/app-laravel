document.addEventListener("alpine:init",(()=>{Alpine.data("managerFrm",(()=>({modalStatus:new bootstrap.Modal(document.getElementById("modal-status")),setModalStatus(e,t){document.getElementById("title-modal-status").innerText=e,document.getElementById("desc-status-modal").innerText=t},emailRegex:/^(\s?[^\s,]+@[^\s,]+\.[^\s,]+\s?,)*(\s?[^\s,]+@[^\s,]+\.[^\s,]+)$/,activeEmails:[],selectedEmailsIds:[],associatedSingleEmails:[],current:"",data:{},loading:!1,buttonLabel:"Salvar",addObject(e,t){let a=[];for(let s=0;s<e.length;s++)a.push(JSON.parse(`{ "${t}" : "${e[s]}" }`));return a},loadData(){window.addEventListener("DOMContentLoaded",(()=>{let e=document.querySelector("#user_id");$("#user_id").on("change",(function(t){this.selectedEmailsIds=[],Array.from(e.options).map((e=>{e.selected&&this.selectedEmailsIds.push(e.value)}))}))})),document.querySelector("#add").addEventListener("click",(e=>{this.add()})),this.loading=!0,fetch(document.getElementById("route_edit").value).then((e=>e.json())).then((e=>{null!=e.data.id&&(document.getElementById("initials").value=e.data.initials,document.getElementById("name").value=e.data.name,document.getElementById("system").value=e.data.system,document.getElementById("status").value=e.data.status,document.getElementById("path_script").value=e.data.path_script,document.getElementById("description").value=e.data.description,document.getElementById("mail_title").value=e.data.mail_title,document.getElementById("mail_attach").value=e.data.mail_attach,document.getElementById("mail_message").value=e.data.mail_message),this.selectedEmailsIds=null!=e.data.mails_users?arrayColumn(e.data.mails_users,"user_id"):[],this.associatedSingleEmails=null!=e.data.mails_singles?arrayColumn(e.data.mails_singles,"mail"):[],this.activeEmails=e.emails_cadastrados,this.loading=!1,this.comboUserId(this.activeEmails,this.selectedEmailsIds);let t=this;this.associatedSingleEmails.length&&t.eventDel()}))},eventDel(){let e=this;setTimeout((function(){$(".bt-del").off("click"),$(".bt-del").on("click",(async function(t){e.remove($(this).attr("email"))}))}),1e3)},comboUserId(e,t){let a=document.getElementById("user_id"),s="";e.forEach((e=>{let a=t.indexOf(e.id)>=0?"selected":"";s+=`<option ${a} value="${e.id}">${e.email}</option>`})),a.innerHTML=s},submitData(){if($("#frm").valid()){if(this.data._method=null!==document.querySelector('input[name="_method"]')?document.querySelector('input[name="_method"]').value:null,this.data.system=document.getElementById("system").value,this.data.user_id=this.addObject($("#user_id").val(),"user_id"),this.data.mail=this.addObject(this.associatedSingleEmails,"mail"),this.data.initials=document.getElementById("initials").value,this.data.name=document.getElementById("name").value,this.data.system=document.getElementById("system").value,this.data.status=document.getElementById("status").value,this.data.path_script=document.getElementById("path_script").value,this.data.description=document.getElementById("description").value,this.data.mail_title=document.getElementById("mail_title").value,this.data.mail_attach=document.getElementById("mail_attach").value,this.data.mail_message=document.getElementById("mail_message").value,0==this.data.user_id.length&&0==this.data.mail.length)return this.setModalStatus("Selecione quem recebe ou adicione um email avulso!","Verifique, por favor!"),void this.modalStatus.show();this.buttonLabel="Aguarde...",this.loading=!0,fetch(document.getElementById("frm").action,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.head.querySelector("meta[name=csrf-token]").content},body:JSON.stringify(this.data)}).then((e=>{1!=e.ok&&this.setModalStatus("Algo errado!","Se persistir, fale com o administrador!"),e.json().then((e=>{this.setModalStatus("Muito bom!","Adicionado com sucesso!"),null!=e.redirect&&(window.location.href=e.redirect)}))})).catch((()=>{this.setModalStatus("Error grave!","Se persistir, fale com o administrador!")})).finally((()=>{this.modalStatus.show(),this.loading=!1,this.buttonLabel="Salvar"}))}},add(){let e=document.getElementById("current").value;1==this.emailRegex.test(e)?(this.associatedSingleEmails.push(e.trim()),this.associatedSingleEmails=[...new Set(this.associatedSingleEmails)],document.getElementById("current").value=""):(this.setModalStatus("E-mail não informado ou inválido!","Verifique, por favor!"),this.modalStatus.show(),document.getElementById("current").focus()),this.eventDel()},remove(e){this.associatedSingleEmails.splice(this.associatedSingleEmails.indexOf(e),1)}})))}));
