document.addEventListener("alpine:init",(()=>{Alpine.data("managerFrm",(()=>({categories:{},files:{},selectedFiles:"",list:{},loading:!1,buttonLabel:"Cadastrar",target:document.getElementById("drag_drop_area"),loadData(){document.querySelector("#files").addEventListener("change",(e=>{this.change(e)})),this.target.addEventListener("dragover",(e=>{this.dragover(this,e)})),this.target.addEventListener("dragleave",(e=>{this.dragleave(this,e)})),this.target.addEventListener("drop",(e=>{this.drop(this,e)})),this.loading=!0,this.buttonLabel="Aguarde, carregando dados...",fetch(document.getElementById("route_datapage").value).then((e=>e.json())).then((e=>{this.categories=e.categories,this.list=e.documents})).finally((()=>{this.loading=!1,this.buttonLabel="Cadastrar"}))},clearFields(e,t=!1){e.loading=!1,e.buttonLabel="Cadastrar",document.getElementById("files").value="",e.files={},e.selectedFiles="",document.getElementById("category_id").value="",t&&(document.getElementById("progress-bar").style.width="0%",document.getElementById("progress-bar").innerHTML="0%")},validFiles(){let e=[],t=[],s=new DataTransfer;if(this.files.length>5){return this.clearFields(this),this.setModalStatus("Muitos arquivos!","Envie no máximo 5 arquivos."),void new bootstrap.Modal(document.getElementById("modal-status")).show()}for(let a=0;a<this.files.length;a++)this.files[a].size<=10485760?(e.push(this.files[a].name),s.items.add(this.files[a])):t.push(this.files[a].name);if(t.length){this.setModalStatus("Arquivos muito grande!",t.join(", ")),new bootstrap.Modal(document.getElementById("modal-status")).show()}this.files=s.files,this.selectedFiles=this.files.length>0?this.files.length+" arquivos serão enviados: "+e.join(" | "):""},change(e){this.files=e.target.files,this.validFiles()},dragover(e,t){t.preventDefault(),this.target.classList.add("drag_drop_active")},dragleave(e,t){t.preventDefault(),this.target.classList.remove("drag_drop_active")},drop(e,t){t.preventDefault(),this.target.classList.remove("drag_drop_active"),this.files=t.dataTransfer.files,this.validFiles()},setModalStatus(e,t){document.getElementById("title-modal-status").innerText=e,document.getElementById("desc-status-modal").innerText=t},submitData(){if($("#frm").valid()){if(0==Object.keys(this.files).length){return this.setModalStatus("Nenhum arquivo!","Selecione algum, por favor."),void new bootstrap.Modal(document.getElementById("modal-status")).show()}this.loading=!0,this.buttonLabel="Aguarde, cadatrando arquivos...";const e=new FormData;e.append("category_id",document.getElementById("category_id").value),e.append("_token",document.head.querySelector("meta[name=csrf-token]").content);for(let t=0;t<this.files.length;t++)e.append("file["+t+"]",this.files[t]);let t=new XMLHttpRequest;t.open("POST",document.getElementById("frm").action);let s=this;t.onload=function(){200===t.status&&1==JSON.parse(this.responseText).response_status?(s.setModalStatus("Muito bom!","Arquivos enviados com sucesso!"),table.clear().draw(),table.ajax.reload(),table.order([0,"desc"]).draw()):s.setModalStatus("Algo errado!","Se persistir, fale com o administrador!"),new bootstrap.Modal(document.getElementById("modal-status")).show(),s.clearFields(s,!0)},t.upload.onprogress=function(e){let t=Math.round(e.loaded/e.total*100);document.getElementById("progress-bar").style.width=t+"%",document.getElementById("progress-bar").innerHTML=t+"%"},t.send(e)}}})))}));
